# Svensk Docker Compose konfiguration
# Följer MSB säkerhetsriktlinjer och svensk dataskyddslagstiftning

version: '3.8'

services:
  # CRM Applikation med svensk säkerhet
  crm-app:
    build: 
      context: .
      dockerfile: Dockerfile.swedish
    container_name: crm-sweden
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - TZ=Europe/Stockholm
      - LOCALE=sv_SE.UTF-8
      - GDPR_COMPLIANCE=true
      - DATA_LOCATION=sweden
      - AUDIT_ENABLED=true
    volumes:
      - crm_data:/app/data
      - crm_logs:/app/logs
      - backup_data:/app/backup
    networks:
      - crm-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    user: "10001:10001"
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "sweden,gdpr,audit"
    labels:
      - "se.crm.component=application"
      - "se.crm.datacenter=sweden"
      - "se.crm.gdpr=compliant"

  # PostgreSQL med svensk konfiguration
  crm-database:
    image: postgres:15-alpine
    container_name: crm-db-sweden
    environment:
      - POSTGRES_DB=crm_sweden
      - POSTGRES_USER=crm_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - TZ=Europe/Stockholm
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_backup:/backup
      - ./init-db-swedish.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - crm-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: "postgres"
    secrets:
      - db_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U crm_user -d crm_sweden"]
      interval: 30s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "sweden,database,gdpr"
    labels:
      - "se.crm.component=database"
      - "se.crm.datacenter=sweden"
      - "se.crm.gdpr=compliant"

  # Redis för sessionshantering
  crm-redis:
    image: redis:7-alpine
    container_name: crm-cache-sweden
    command: redis-server --requirepass "${REDIS_PASSWORD}" --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - crm-network
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: "redis"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    labels:
      - "se.crm.component=cache"
      - "se.crm.datacenter=sweden"

  # Backup service för svensk compliance
  crm-backup:
    image: alpine:3.18
    container_name: crm-backup-sweden
    volumes:
      - crm_data:/source/app:ro
      - postgres_data:/source/db:ro
      - backup_data:/backup
      - /opt/crm-backup:/external-backup
    networks:
      - crm-network
    environment:
      - TZ=Europe/Stockholm
      - BACKUP_SCHEDULE=0 2 * * *
      - RETENTION_DAYS=2555  # 7 år enligt svensk lag
      - ENCRYPTION_ENABLED=true
    command: |
      sh -c "
        apk add --no-cache dcron gnupg tar gzip &&
        echo '0 2 * * * /backup-script.sh' | crontab - &&
        cat > /backup-script.sh << 'SCRIPT'
      #!/bin/sh
      DATE=$$(date +%Y%m%d_%H%M%S)
      echo \"$$(date): Startar svensk säkerhetsbackup\"
      
      # Skapa komprimerad backup
      tar czf /backup/crm-full-$$DATE.tar.gz -C /source .
      
      # Kryptera för svensk säkerhet
      gpg --cipher-algo AES256 --compress-algo 1 --cert-digest-algo SHA256 --symmetric --batch --yes --passphrase \"${BACKUP_PASSPHRASE}\" --output /backup/crm-encrypted-$$DATE.gpg /backup/crm-full-$$DATE.tar.gz
      
      # Ta bort okrypterad fil
      rm /backup/crm-full-$$DATE.tar.gz
      
      # Kopiera till extern backup
      cp /backup/crm-encrypted-$$DATE.gpg /external-backup/
      
      # Rensa gamla backups (behåll enligt retention)
      find /backup -name \"*.gpg\" -mtime +${RETENTION_DAYS} -delete
      find /external-backup -name \"*.gpv\" -mtime +30 -delete
      
      echo \"$$(date): Backup slutförd\"
      SCRIPT
      chmod +x /backup-script.sh &&
      crond -f"
    restart: unless-stopped
    labels:
      - "se.crm.component=backup"
      - "se.crm.datacenter=sweden"
      - "se.crm.gdpr=compliant"

  # Övervakning och säkerhet
  crm-monitoring:
    image: alpine:3.18
    container_name: crm-monitor-sweden
    volumes:
      - crm_logs:/logs:ro
      - /var/log:/host-logs:ro
    networks:
      - crm-network
    environment:
      - TZ=Europe/Stockholm
      - ALERT_EMAIL=admin@din-domän.se
    command: |
      sh -c "
        apk add --no-cache dcron curl jq &&
        cat > /monitor-script.sh << 'SCRIPT'
      #!/bin/sh
      LOG_FILE=\"/logs/security-monitor.log\"
      
      echo \"$$(date): Startar säkerhetsövervakning\" >> $$LOG_FILE
      
      # Kontrollera CRM hälsa
      if ! curl -f http://crm-app:3000/api/health > /dev/null 2>&1; then
          echo \"$$(date): KRITISKT - CRM svarar inte!\" >> $$LOG_FILE
      fi
      
      # Kontrollera databas
      if ! nc -z crm-database 5432; then
          echo \"$$(date): KRITISKT - Databas ej tillgänglig!\" >> $$LOG_FILE
      fi
      
      # Kontrollera disk space
      DISK_USAGE=$$(df /logs | tail -1 | awk '{print $5}' | sed 's/%//')
      if [ $$DISK_USAGE -gt 80 ]; then
          echo \"$$(date): VARNING - Disk användning $$DISK_USAGE%\" >> $$LOG_FILE
      fi
      
      echo \"$$(date): Övervakning slutförd\" >> $$LOG_FILE
      SCRIPT
      chmod +x /monitor-script.sh &&
      echo '*/15 * * * * /monitor-script.sh' | crontab - &&
      crond -f"
    restart: unless-stopped
    labels:
      - "se.crm.component=monitoring"
      - "se.crm.datacenter=sweden"

  # GDPR Compliance Service
  gdpr-service:
    build:
      context: .
      dockerfile: Dockerfile.gdpr
    container_name: crm-gdpr-sweden
    volumes:
      - crm_data:/app/data
      - gdpr_logs:/app/gdpr-logs
    networks:
      - crm-network
    environment:
      - TZ=Europe/Stockholm
      - GDPR_RETENTION_YEARS=7
      - AUTO_DELETION_ENABLED=true
      - AUDIT_TRAIL_ENABLED=true
    command: |
      sh -c "
        cat > /app/gdpr-compliance.js << 'SCRIPT'
      const fs = require('fs');
      const path = require('path');
      
      // GDPR Compliance funktioner
      class GDPRCompliance {
          constructor() {
              this.retentionYears = process.env.GDPR_RETENTION_YEARS || 7;
              this.dataPath = '/app/data';
              this.logPath = '/app/gdpr-logs';
          }
          
          // Automatisk dataradering efter 7 år
          async autoDeleteExpiredData() {
              const cutoffDate = new Date();
              cutoffDate.setFullYear(cutoffDate.getFullYear() - this.retentionYears);
              
              console.log(`GDPR: Raderar data äldre än \${cutoffDate.toISOString()}`);
              // Implementation för automatisk radering
          }
          
          // Generera GDPR rapport
          async generateGDPRReport() {
              const report = {
                  timestamp: new Date().toISOString(),
                  dataRetentionPeriod: `\${this.retentionYears} år`,
                  location: 'Sverige',
                  compliance: 'GDPR Article 17 - Right to erasure'
              };
              
              fs.writeFileSync(
                  path.join(this.logPath, `gdpr-report-\${Date.now()}.json`),
                  JSON.stringify(report, null, 2)
              );
          }
      }
      
      const gdpr = new GDPRCompliance();
      
      // Kör GDPR kontroller dagligen
      setInterval(() => {
          gdpr.autoDeleteExpiredData();
          gdpr.generateGDPRReport();
      }, 24 * 60 * 60 * 1000); // 24 timmar
      
      console.log('GDPR Compliance Service startad för Sverige');
      SCRIPT
      node /app/gdpr-compliance.js"
    restart: unless-stopped
    labels:
      - "se.crm.component=gdpr"
      - "se.crm.datacenter=sweden"
      - "se.crm.gdpr=compliant"

# Nätverk för säker intern kommunikation
networks:
  crm-network:
    driver: bridge
    internal: false  # Behöver extern access för certifikat
    ipam:
      config:
        - subnet: 172.20.0.0/16
    labels:
      - "se.crm.network=internal"
      - "se.crm.datacenter=sweden"

# Säkra volymer för persistent data
volumes:
  crm_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/crm-data
    labels:
      - "se.crm.data=application"
      - "se.crm.datacenter=sweden"
      - "se.crm.gdpr=compliant"

  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/crm-db
    labels:
      - "se.crm.data=database"
      - "se.crm.datacenter=sweden"
      - "se.crm.gdpr=compliant"

  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/crm-cache
    labels:
      - "se.crm.data=cache"
      - "se.crm.datacenter=sweden"

  backup_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/crm-backup
    labels:
      - "se.crm.data=backup"
      - "se.crm.datacenter=sweden"
      - "se.crm.encryption=enabled"

  crm_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/crm-logs
    labels:
      - "se.crm.data=logs"
      - "se.crm.retention=7years"

  postgres_backup:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/crm-db-backup
    labels:
      - "se.crm.data=db-backup"
      - "se.crm.datacenter=sweden"

  gdpr_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/crm-gdpr-logs
    labels:
      - "se.crm.data=gdpr-logs"
      - "se.crm.retention=permanent"

# Docker secrets för säker lösenordshantering
secrets:
  db_password:
    file: ./secrets/db_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
  backup_passphrase:
    file: ./secrets/backup_passphrase.txt