# ğŸ”„ Azure B2C User Sync - Visual Flow

## ğŸ“Š Ã–versikt: FrÃ¥n registrering till CRM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NYA MÃ„KLARE REGISTRERAR SIG                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ğŸ‘¤ MÃ¤klare
     â”‚
     â”‚ 1. GÃ¥r till er tjÃ¤nst
     â”‚    https://varderingsdata.se
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Landing Page       â”‚
â”‚  [Registrera] â†’     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ 2. Redirect till Azure B2C
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Azure AD B2C Signup Page           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Skapa konto                   â”‚  â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  â”‚
â”‚  â”‚ Namn: [Anna Andersson    ]   â”‚  â”‚
â”‚  â”‚ E-post: [anna@era.se     ]   â”‚  â”‚
â”‚  â”‚ FÃ¶retag: [ERA MalmÃ¶      ]   â”‚  â”‚
â”‚  â”‚ Telefon: [070-123 45 67  ]   â”‚  â”‚
â”‚  â”‚ Roll: [MÃ¤klare â–¼         ]   â”‚  â”‚
â”‚  â”‚                               â”‚  â”‚
â”‚  â”‚       [Skapa konto]           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ 3. AnvÃ¤ndare skapas i B2C
               â”‚    Object ID: abc-123-def
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AUTOMATISK SYNKRONISERING (3 METODER)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Metod 1: WEBHOOK (Real-time) âš¡ REKOMMENDERAT                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Azure B2C                          CRM Backend
    â”‚                                   â”‚
    â”‚ 4. Webhook trigger                â”‚
    â”‚   POST /api/webhooks/             â”‚
    â”‚        b2c/user-created           â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚   {                               â”‚
    â”‚     userId: "abc-123-def",        â”‚
    â”‚     eventType: "user.created"     â”‚
    â”‚   }                               â”‚
    â”‚                                   â”‚
    â”‚                                   â–¼
    â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           â”‚ 5. HÃ¤mta user   â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ frÃ¥n Graph API  â”‚
    â”‚   GET /users/abc-123-def  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚   User data â†’                     â”‚
    â”‚                                   â”‚
    â”‚                                   â–¼
    â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           â”‚ 6. Konvertera   â”‚
    â”‚                           â”‚ till CRM-format â”‚
    â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                   â”‚
    â”‚                                   â–¼
    â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           â”‚ 7. Matcha mot   â”‚
    â”‚                           â”‚ fÃ¶retag i CRM   â”‚
    â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                   â”‚
    â”‚                                   â”‚ "ERA MalmÃ¶" found!
    â”‚                                   â”‚ companyId: "company-456"
    â”‚                                   â”‚
    â”‚                                   â–¼
    â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           â”‚ 8. LÃ¤gg till    â”‚
    â”‚                           â”‚ i state.users[] â”‚
    â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                   â”‚
    â”‚                                   â–¼
    â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           â”‚ 9. Spara state  â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ & Audit log     â”‚
    â”‚   PATCH /users/           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚   extension_CompanyId             â”‚
    â”‚                                   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚   OK âœ“                            â”‚
    â”‚                                   â”‚
                                        â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ 10. AnvÃ¤ndare synlig â”‚
                              â”‚  i CRM-grÃ¤nssnittet  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â±ï¸  Total tid: < 1 sekund


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Metod 2: POLLING (Scheduled) ğŸ”„                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CRM Backend (kÃ¶rs var 15:e minut)
    â”‚
    â”‚ Cron job / setInterval
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check last sync time       â”‚
â”‚ lastSync: 2025-10-08 12:00 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Microsoft Graph API                    â”‚
â”‚ GET /users?$filter=                    â”‚
â”‚   createdDateTime ge 2025-10-08T12:00  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Process new users          â”‚
â”‚ - Map to CRM format        â”‚
â”‚ - Link to companies        â”‚
â”‚ - Add to state.users[]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update lastSync time       â”‚
â”‚ lastSync: 2025-10-08 12:15 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â±ï¸  Total fÃ¶rdrÃ¶jning: 0-15 minuter


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Metod 3: MANUAL SYNC (On-demand) ğŸ‘¨â€ğŸ’¼                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Admin i CRM-grÃ¤nssnitt
    â”‚
    â”‚ Klickar "â†» Synkronisera anvÃ¤ndare"
    â”‚
    â–¼
POST /api/users/sync-from-b2c
{ mode: "full" }
    â”‚
    â–¼
HÃ¤mtar ALLA anvÃ¤ndare frÃ¥n Graph API
    â”‚
    â–¼
Uppdaterar state.users[]
    â”‚
    â–¼
"âœ“ 150 anvÃ¤ndare synkroniserade"

    â±ï¸  Total tid: 2-5 sekunder (beroende pÃ¥ antal anvÃ¤ndare)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ“‹ DATA MAPPING: Azure B2C â†’ CRM

Azure B2C User Object:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                                     â”‚
â”‚   id: "abc-123-def-456",             â”‚
â”‚   displayName: "Anna Andersson",     â”‚
â”‚   givenName: "Anna",                 â”‚
â”‚   surname: "Andersson",              â”‚
â”‚   identities: [{                     â”‚
â”‚     signInType: "emailAddress",      â”‚
â”‚     issuerAssignedId: "anna@era.se"  â”‚
â”‚   }],                                â”‚
â”‚   jobTitle: "FastighetsmÃ¤klare",     â”‚
â”‚   companyName: "ERA MalmÃ¶",          â”‚
â”‚   mobilePhone: "+46701234567",       â”‚
â”‚   extension_Role: "sales",           â”‚
â”‚   extension_CompanyId: null,         â”‚
â”‚   createdDateTime: "2025-10-08..."   â”‚
â”‚ }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ mapB2CUserToCRM()
              â–¼
CRM User Object:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                                     â”‚
â”‚   id: "b2c-abc-123-def-456",         â”‚
â”‚   azureB2CId: "abc-123-def-456",     â”‚
â”‚   username: "anna@era.se",           â”‚
â”‚   email: "anna@era.se",              â”‚
â”‚   name: "Anna Andersson",            â”‚
â”‚   firstName: "Anna",                 â”‚
â”‚   lastName: "Andersson",             â”‚
â”‚   role: "sales",                     â”‚
â”‚   companyId: "company-456",    â† ğŸ”  â”‚
â”‚   companyName: "ERA MalmÃ¶",          â”‚
â”‚   phone: "+46701234567",             â”‚
â”‚   isActive: true,                    â”‚
â”‚   createdAt: "2025-10-08...",        â”‚
â”‚   syncedAt: "2025-10-08...",         â”‚
â”‚   source: "azure-b2c"          â† âœ¨  â”‚
â”‚ }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ” companyId: Automatiskt matchat mot state.companies[]
âœ¨ source: Markerar att anvÃ¤ndaren kom frÃ¥n Azure B2C


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ”— AUTOMATISK FÃ–RETAGSKOPPLING

state.companies:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [                                    â”‚
â”‚   {                                  â”‚
â”‚     id: "company-456",               â”‚
â”‚     name: "ERA MalmÃ¶",         â† ğŸ¯  â”‚
â”‚     brandId: "era",                  â”‚
â”‚     city: "MalmÃ¶"                    â”‚
â”‚   },                                 â”‚
â”‚   ...                                â”‚
â”‚ ]                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Matchningsalgoritm:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user.companyName = "ERA MalmÃ¶"                   â”‚
â”‚                                                  â”‚
â”‚ SÃ¶ker i companies dÃ¤r:                           â”‚
â”‚   company.name.includes("ERA MalmÃ¶") OR          â”‚
â”‚   "ERA MalmÃ¶".includes(company.name)             â”‚
â”‚                                                  â”‚
â”‚ Hittar: company-456                        âœ“     â”‚
â”‚ SÃ¤tter: user.companyId = "company-456"           â”‚
â”‚                                                  â”‚
â”‚ Uppdaterar Ã¤ven i Azure B2C:                     â”‚
â”‚   extension_CompanyId = "company-456"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ¨ UI INTEGRATION

Frontend (app.js):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ‘¥ AnvÃ¤ndare                               â”‚    â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚
â”‚  â”‚                                             â”‚    â”‚
â”‚  â”‚ [â†» Synka nya]  [âŸ³ Full synk]  [ğŸ”— Koppla] â”‚    â”‚
â”‚  â”‚                                             â”‚    â”‚
â”‚  â”‚ Senaste synk: 2025-10-08 12:30              â”‚    â”‚
â”‚  â”‚ Auto-synk: Aktiv (var 15:e minut)           â”‚    â”‚
â”‚  â”‚ B2C-anvÃ¤ndare: 75                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Namn          â”‚ E-post        â”‚ FÃ¶retag    â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ Anna Anderss..â”‚ anna@era.se   â”‚ ERA MalmÃ¶  â”‚    â”‚
â”‚  â”‚ ğŸŸ¢ Aktiv      â”‚ ğŸ”µ azure-b2c  â”‚ Skapad...  â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ Johan Johanss.â”‚ johan@svensk..â”‚ Svensk ... â”‚    â”‚
â”‚  â”‚ ğŸŸ¢ Aktiv      â”‚ ğŸ”µ azure-b2c  â”‚ Skapad...  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ”’ SÃ„KERHET

Webhook Signature Verification:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Azure B2C                              â”‚
â”‚   â”‚                                    â”‚
â”‚   â”‚ 1. Prepare payload                 â”‚
â”‚   â”‚    body = { userId: "...", ... }   â”‚
â”‚   â”‚                                    â”‚
â”‚   â”‚ 2. Calculate HMAC-SHA256           â”‚
â”‚   â”‚    signature = HMAC(              â”‚
â”‚   â”‚      secret,                       â”‚
â”‚   â”‚      JSON.stringify(body)          â”‚
â”‚   â”‚    )                               â”‚
â”‚   â”‚                                    â”‚
â”‚   â”‚ 3. Send request                    â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚
â”‚   â”‚    POST /api/webhooks/...          â”‚
â”‚   â”‚    x-azure-signature: abc123...    â”‚
â”‚   â”‚    body: { userId: "...", ... }    â”‚
â”‚   â”‚                                    â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CRM Backend                              â”‚
â”‚                                          â”‚
â”‚ 1. Extract signature from header        â”‚
â”‚    receivedSig = req.headers[           â”‚
â”‚      'x-azure-signature'                 â”‚
â”‚    ]                                     â”‚
â”‚                                          â”‚
â”‚ 2. Calculate expected signature         â”‚
â”‚    expectedSig = HMAC(                   â”‚
â”‚      process.env.                        â”‚
â”‚        AZURE_B2C_WEBHOOK_SECRET,         â”‚
â”‚      JSON.stringify(req.body)            â”‚
â”‚    )                                     â”‚
â”‚                                          â”‚
â”‚ 3. Timing-safe comparison                â”‚
â”‚    if (timingSafeEqual(                  â”‚
â”‚      receivedSig, expectedSig            â”‚
â”‚    )) {                                  â”‚
â”‚      // Process webhook âœ“               â”‚
â”‚    } else {                              â”‚
â”‚      // Return 401 Unauthorized âœ—       â”‚
â”‚    }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ“Š MONITORING & AUDIT

Audit Log Entry:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                                                 â”‚
â”‚   "ts": "2025-10-08T12:30:45.123Z",              â”‚
â”‚   "action": "b2c_user_synced",                   â”‚
â”‚   "entityType": "user",                          â”‚
â”‚   "entityId": "b2c-abc-123-def-456",             â”‚
â”‚   "userId": "system",                            â”‚
â”‚   "details": {                                   â”‚
â”‚     "eventType": "user.created",                 â”‚
â”‚     "azureB2CId": "abc-123-def-456",             â”‚
â”‚     "email": "anna@era.se",                      â”‚
â”‚     "companyMatched": "company-456",             â”‚
â”‚     "source": "webhook"                          â”‚
â”‚   }                                              â”‚
â”‚ }                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Application Insights Tracking:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event: "B2C_UserSynced"                          â”‚
â”‚ Properties:                                       â”‚
â”‚   - userId: "b2c-abc-123..."                     â”‚
â”‚   - email: "anna@era.se"                         â”‚
â”‚   - companyId: "company-456"                     â”‚
â”‚   - source: "webhook"                            â”‚
â”‚   - syncDuration: 245ms                          â”‚
â”‚   - success: true                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## ğŸ¯ SAMMANFATTNING

âœ… Tre synkroniseringsmetoder:
   1. Webhooks (real-time, < 1s)
   2. Polling (scheduled, var 15:e minut)
   3. Manual (on-demand, admin-trigger)

âœ… Automatisk fÃ¶retagskoppling:
   - Matchar user.companyName mot companies
   - Uppdaterar bÃ¥de CRM och Azure B2C

âœ… SÃ¤ker implementation:
   - HMAC-SHA256 signature verification
   - Timing-safe comparison
   - Audit logging

âœ… Full transparens:
   - Sync status synlig i UI
   - Audit trail fÃ¶r alla Ã¤ndringar
   - Application Insights tracking

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
