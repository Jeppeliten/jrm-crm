// ===== TABLE RENDERING FUNCTIONS =====

async function loadCompanies() {
  console.log('Loading companies data...');
  try {
    const response = await fetchWithAuth(`${CONFIG.apiBaseUrl}/companies`);
    const companies = await response.json();
    renderCompaniesTable(companies);
  } catch (error) {
    console.error('Error loading companies:', error);
    document.getElementById('companyTable').innerHTML = '<p class="text-red-500">Fel vid laddning av företag</p>';
  }
}

async function loadBrands() {
  console.log('Loading brands data...');
  try {
    const response = await fetchWithAuth(`${CONFIG.apiBaseUrl}/brands`);
    const brands = await response.json();
    renderBrandsTable(brands);
  } catch (error) {
    console.error('Error loading brands:', error);
    document.getElementById('brandTable').innerHTML = '<p class="text-red-500">Fel vid laddning av varumärken</p>';
  }
}

async function loadAgents() {
  console.log('Loading agents data...');
  try {
    const response = await fetchWithAuth(`${CONFIG.apiBaseUrl}/agents`);
    const agents = await response.json();
    renderAgentsTable(agents);
  } catch (error) {
    console.error('Error loading agents:', error);
    document.getElementById('agentTable').innerHTML = '<p class="text-red-500">Fel vid laddning av mäklare</p>';
  }
}

function renderCompaniesTable(companies) {
  const tableHtml = `
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Företag</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Varumärke</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pipeline</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Org.nr</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">E-post</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefon</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Åtgärder</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        ${companies.map(company => `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">${company.name || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">${company.brand || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(company.status)}">
                ${company.status || 'prospekt'}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${company.pipeline || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">${company.orgNumber || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">${company.email || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">${company.phone || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <button onclick="editCompany('${company._id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Redigera</button>
              <button onclick="deleteCompany('${company._id}')" class="text-red-600 hover:text-red-900">Ta bort</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  document.getElementById('companyTable').innerHTML = tableHtml;
}

function renderBrandsTable(brands) {
  const tableHtml = `
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Varumärke</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Webbplats</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Beskrivning</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Åtgärder</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        ${brands.map(brand => `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap font-medium">${brand.name || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">${brand.category || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(brand.status)}">
                ${brand.status || 'aktiv'}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              ${brand.website ? `<a href="${brand.website}" target="_blank" class="text-indigo-600 hover:text-indigo-900">${brand.website}</a>` : ''}
            </td>
            <td class="px-6 py-4">${brand.description || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <button onclick="editBrand('${brand._id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Redigera</button>
              <button onclick="deleteBrand('${brand._id}')" class="text-red-600 hover:text-red-900">Ta bort</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  document.getElementById('brandTable').innerHTML = tableHtml;
}

function renderAgentsTable(agents) {
  const tableHtml = `
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Namn</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Företag</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roll</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Licens</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">E-post</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefon</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Åtgärder</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        ${agents.map(agent => `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap font-medium">${agent.name || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">${agent.company || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">${agent.role || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadgeClass(agent.status)}">
                ${agent.status || 'aktiv'}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${agent.licenseType || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">${agent.email || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap">${agent.phone || ''}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <button onclick="editAgent('${agent._id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Redigera</button>
              <button onclick="deleteAgent('${agent._id}')" class="text-red-600 hover:text-red-900">Ta bort</button>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  document.getElementById('agentTable').innerHTML = tableHtml;
}

function getStatusBadgeClass(status) {
  const statusLower = (status || '').toLowerCase();
  if (statusLower === 'aktiv' || statusLower === 'kund') return 'bg-green-100 text-green-800';
  if (statusLower === 'prospekt' || statusLower === 'pending') return 'bg-yellow-100 text-yellow-800';
  if (statusLower === 'inaktiv' || statusLower === 'archived') return 'bg-red-100 text-red-800';
  return 'bg-gray-100 text-gray-800';
}
